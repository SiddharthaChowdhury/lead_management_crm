<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/waterline/adapter/ddl/index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../../index.html">all files</a> / <a href="index.html">lib/waterline/adapter/ddl/</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.68% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>42/57</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">57.69% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>15/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">84.78% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>39/46</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-yes">1168×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">263×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">528×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">528×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">528×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Module dependencies
 */
&nbsp;
var _ = require('lodash');
var normalize = require('../../utils/normalize');
var getRelations = require('../../utils/getRelations');
var hasOwnProperty = require('../../utils/helpers').object.hasOwnProperty;
&nbsp;
&nbsp;
/**
 * DDL Adapter Normalization
 */
&nbsp;
module.exports = {
&nbsp;
  define: function(cb) {
    var self = this;
&nbsp;
    // Normalize Arguments
    cb = normalize.callback(cb);
&nbsp;
    // Build Default Error Message
    var errMsg = 'No define() method defined in adapter!';
&nbsp;
    // Grab attributes from definition
    var schema = _.clone(this.query._schema.schema) || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
&nbsp;
    // Find any junctionTables that reference this collection
    var relations = getRelations({
      schema: self.query.waterline.schema,
      parentCollection: self.collection
    });
&nbsp;
    //
    // TODO: if junction tables don't exist, define them
    // console.log(relations);
    //
&nbsp;
    // Verify that collection doesn't already exist
    // and then define it and trigger callback
    this.describe(function(err, existingAttributes) {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (err) <span class="cstat-no" title="statement not covered" >return cb(err);</span>
      <span class="missing-if-branch" title="if path not taken" >I</span>if (existingAttributes) <span class="cstat-no" title="statement not covered" >return cb(new Error('Trying to define a collection (' + self.collection + ') which already exists.'));</span>
&nbsp;
      // Remove hasMany association keys before sending down to adapter
      Object.keys(schema).forEach(function(key) {
        if (schema[key].type) return;
        delete schema[key];
      });
&nbsp;
      // Find the connection to run this on
      if (!hasOwnProperty(self.dictionary, 'define')) return cb();
&nbsp;
      var connName = self.dictionary.define;
      var adapter = self.connections[connName]._adapter;
&nbsp;
      <span class="missing-if-branch" title="if path not taken" >I</span>if (!hasOwnProperty(adapter, 'define')) <span class="cstat-no" title="statement not covered" >return cb(new Error(errMsg));</span>
      adapter.define(connName, self.collection, schema, cb);
    });
  },
&nbsp;
  describe: function(cb) {
&nbsp;
    // Normalize Arguments
    cb = normalize.callback(cb);
&nbsp;
    // Build Default Error Message
    var err = 'No describe() method defined in adapter!';
&nbsp;
    // Find the connection to run this on
    // NOTE: if `describe` doesn't exist, an error is not being returned.
    if (!hasOwnProperty(this.dictionary, 'describe')) return cb();
&nbsp;
    var connName = this.dictionary.describe;
    var adapter = this.connections[connName]._adapter;
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!hasOwnProperty(adapter, 'describe')) <span class="cstat-no" title="statement not covered" >return cb(new Error(err));</span>
    adapter.describe(connName, this.collection, cb);
  },
&nbsp;
  drop: function(relations, cb) {
    // Allow relations to be optional
    if (typeof relations === 'function') {
      cb = relations;
      relations = [];
    }
&nbsp;
    relations = [];
&nbsp;
    //
    // TODO:
    // Use a more normalized strategy to get relations so we can omit the extra argument above.
    // e.g. getRelations({ schema: self.query.waterline.schema, parentCollection: self.collection });
    //
&nbsp;
    // Normalize Arguments
    cb = normalize.callback(cb);
&nbsp;
    // Build Default Error Message
    var err = 'No drop() method defined in adapter!';
&nbsp;
    // Find the connection to run this on
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!hasOwnProperty(this.dictionary, 'drop')) <span class="cstat-no" title="statement not covered" >return cb(new Error(err));</span>
&nbsp;
    var connName = this.dictionary.drop;
    var adapter = this.connections[connName]._adapter;
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!hasOwnProperty(adapter, 'drop')) <span class="cstat-no" title="statement not covered" >return cb(new Error(err));</span>
    adapter.drop(connName, this.collection, relations, cb);
  },
&nbsp;
  alter: <span class="fstat-no" title="function not covered" >function(cb) {</span>
&nbsp;
    // Normalize arguments
<span class="cstat-no" title="statement not covered" >    cb = normalize.callback(cb);</span>
&nbsp;
    // Build Default Error Message
<span class="cstat-no" title="statement not covered" >    var err = 'No alter() method defined in adapter!';</span>
&nbsp;
    // Find the connection to run this on
<span class="cstat-no" title="statement not covered" >    if (!hasOwnProperty(this.dictionary, 'alter')) <span class="cstat-no" title="statement not covered" >return cb(new Error(err));</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var connName = this.dictionary.alter;</span>
<span class="cstat-no" title="statement not covered" >    var adapter = this.connections[connName]._adapter;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!hasOwnProperty(adapter, 'alter')) <span class="cstat-no" title="statement not covered" >return cb(new Error(err));</span></span>
<span class="cstat-no" title="statement not covered" >    adapter.alter(connName, this.collection, cb);</span>
  }
&nbsp;
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 18 2016 12:26:23 GMT-0500 (CDT)
</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
